<div class="w-full h-full flex flex-col">
  <!-- En-tête avec recherche - Optimisé pour mobile et desktop -->
  <div class="px-3 sm:px-6 pt-3 sm:pt-6 pb-4 sm:pb-10 bg-primary-600/10 flex-none">
    <div class="flex flex-col gap-3 container px-0">
      <!-- Ligne 1: Titre et Bouton Retour -->
      <div class="flex items-center justify-between w-full">
        <h2 class="display-1 font-bold m-0 flex items-center flex-1">
          <span
            class="w-9 h-9 sm:w-12 sm:h-12 rounded-full text-primary-600 mr-2 sm:mr-4 bg-primary-600/10 flex items-center justify-center flex-shrink-0">
            <mat-icon svgIcon="mat:local_shipping" class="text-xl sm:text-2xl"></mat-icon>
          </span>
          <span class="block text-lg sm:text-2xl truncate">Approvisionnements</span>
        </h2>

        <!-- Bouton Retour - Toujours visible -->
        <button class="flex-shrink-0 ml-2" mat-raised-button color="primary" type="button" (click)="goBack()">
          <mat-icon svgIcon="mat:arrow_back" class="sm:mr-1"></mat-icon>
          <span class="hidden sm:inline">Retour</span>
        </button>
      </div>

      <!-- Ligne 2: Barre de recherche -->
      <div
        class="flex items-center bg-white dark:bg-gray-800 rounded-full overflow-hidden relative pl-4 sm:pl-5 h-11 sm:h-12 w-full shadow-lg">
        <mat-icon class="text-secondary flex-none" svgIcon="mat:search"></mat-icon>
        <input [formControl]="searchCtrl"
          class="border-0 h-11 sm:h-12 outline-none pl-3 sm:pl-4 placeholder:text-secondary bg-transparent flex-auto text-sm sm:text-base w-full"
          placeholder="Rechercher par fournisseur ou numéro..." type="text" />
      </div>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="w-full h-full flex flex-col -mt-4 sm:-mt-6">
    <vex-page-layout-content class="px-4 sm:px-6">
      <!-- En-tête avec compteur et bouton -->
      <div class="card p-3 sm:p-4 md:p-6 mb-3 sm:mb-4 md:mb-6 shadow-sm hover:shadow transition-shadow duration-200">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
          <!-- Compteur -->
          <div class="flex flex-wrap items-center mb-3 sm:mb-0 w-full sm:w-auto">
            <h2 class="text-base sm:text-lg md:text-xl font-bold m-0 mr-2 sm:mr-3">Liste des approvisionnements</h2>
            <div class="flex items-center bg-primary-500 text-white px-2 sm:px-3 py-1 rounded-md text-xs sm:text-sm">
              <span class="font-bold">Nombre:</span>
              <span class="ml-1 sm:ml-2 text-base sm:text-lg font-bold">{{ procurements.length }}</span>
            </div>
          </div>

          <!-- Bouton d'ajout -->
          <div class="flex items-center justify-center sm:justify-end w-full sm:w-auto">
            <button (click)="newProcurement()" color="primary" mat-raised-button matTooltip="Nouvel approvisionnement"
              type="button"
              class="w-full sm:w-auto flex items-center justify-center shadow-md hover:shadow-lg transition-shadow duration-200">
              <mat-icon svgIcon="mat:add" class="mr-1"></mat-icon>
              <span>Nouvel Approvisionnement</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Grille de cartes -->
      <div *ngIf="procurements.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        <div *ngFor="let procurement of procurements"
          class="card rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-all duration-200 cursor-pointer border-l-4"
          [ngClass]="{
            'border-yellow-500': procurement.status === 'pending',
            'border-green-500': procurement.status === 'received',
            'border-red-500': procurement.status === 'cancelled'
          }" (click)="details(procurement)">

          <!-- En-tête de la carte -->
          <div class="p-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <mat-icon svgIcon="mat:receipt" class="text-primary-600"></mat-icon>
                <span class="font-bold text-sm text-gray-700 truncate">{{ procurement.order_number || 'N/A' }}</span>
              </div>
              <button mat-icon-button type="button" (click)="$event.stopPropagation()"
                [matMenuTriggerData]="{ item: procurement }" [matMenuTriggerFor]="actionsMenu"
                class="focus:outline-none -mr-2">
                <mat-icon svgIcon="mat:more_vert"></mat-icon>
              </button>
            </div>
          </div>

          <!-- Corps de la carte -->
          <div class="p-4 space-y-3">
            <!-- Fournisseur -->
            <div class="flex items-start gap-2">
              <mat-icon svgIcon="mat:business" class="text-gray-500 text-sm mt-0.5"></mat-icon>
              <div class="flex-1 min-w-0">
                <p class="text-xs text-gray-500 mb-0.5">Fournisseur</p>
                <p class="text-sm font-semibold text-gray-800 truncate">{{ procurement.supplier.name || 'N/A' }} - {{
                  procurement.supplier.phone_one }} <span *ngIf="procurement.supplier.phone_two"> /
                    {{procurement.supplier.phone_two}}</span> </p>
              </div>
            </div>

            <!-- Date -->
            <div class="flex items-center gap-2">
              <mat-icon svgIcon="mat:calendar_today" class="text-gray-500 text-sm"></mat-icon>
              <div class="flex-1">
                <p class="text-xs text-gray-500 mb-0.5">Date</p>
                <p class="text-sm font-medium text-gray-800">{{ procurement.created_at | date:'dd MMMM yyyy':'':'fr'}}
                </p>
              </div>
            </div>

            <!-- Montant total -->
            <div class="flex items-center gap-2 p-2 bg-primary-50 rounded">
              <mat-icon svgIcon="mat:attach_money" class="text-primary-600 text-sm"></mat-icon>
              <div class="flex-1">
                <p class="text-xs text-gray-600 mb-0.5">Montant total</p>
                <p class="text-base font-bold text-primary-600">{{ procurement.total_amount || 0 }} FCFA</p>
              </div>
            </div>

            <!-- Statut -->
            <div class="flex items-center justify-between pt-2 border-t">
              <span class="text-xs text-gray-600">Statut</span>
              <span class="px-2 py-1 text-xs font-semibold rounded-full" [ngClass]="{
                  'bg-yellow-100 text-yellow-800': procurement.status === 'pending',
                  'bg-green-100 text-green-800': procurement.status === 'received',
                  'bg-red-100 text-red-800': procurement.status === 'cancelled'
                }">
                {{ getStatusLabel(procurement.status) }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Message quand aucun approvisionnement -->
      <div *ngIf="procurements.length === 0"
        class="card flex-auto flex flex-col items-center justify-center py-10 sm:py-16 shadow-sm">
        <!-- <img class="m-6 h-32 sm:h-48 opacity-80" src="assets/img/illustrations/idea.svg" /> -->
        <img class="m-12 h-64" src="assets/img/illustrations/idea.svg" />
        <h2 class="text-xl sm:text-2xl mt-4 mb-6 text-center px-6 font-medium">
          <span>Aucun approvisionnement trouvé</span>
        </h2>
        <button mat-raised-button color="primary" (click)="newProcurement()"
          class="shadow-md hover:shadow-lg transition-shadow duration-200">
          <mat-icon svgIcon="mat:add" class="mr-1"></mat-icon>
          Créer un approvisionnement
        </button>
      </div>

      <!-- Pagination -->
      <mat-paginator *ngIf="procurements.length > 0" [pageSizeOptions]="meta.pageSizeOptions" [pageSize]="meta.per_page"
        [pageIndex]="meta.current_page - 1" [length]="meta.total" (page)="pageEvent($event)" class="sticky left-0 mt-4">
      </mat-paginator>
    </vex-page-layout-content>
  </div>
</div>

<!-- Menu des actions -->
<mat-menu #actionsMenu="matMenu" xPosition="before" yPosition="below">
  <ng-template let-item="item" matMenuContent>
    <button mat-menu-item (click)="details(item)" class="flex items-center">
      <mat-icon svgIcon="mat:visibility" color="accent" class="mr-2"></mat-icon>
      <span>Voir détails</span>
    </button>

    <!-- Bouton Valider - Visible uniquement si le statut est 'pending' -->
    <button *ngIf="item.status === 'pending'" mat-menu-item (click)="validateProcurement(item)"
      class="flex items-center">
      <mat-icon svgIcon="mat:check_circle" class="mr-2 text-green-600"></mat-icon>
      <span class="text-green-600 font-semibold">Valider</span>
    </button>

    <!-- Bouton Annuler - Visible uniquement si le statut est 'pending' -->
    <button *ngIf="item.status === 'pending'" mat-menu-item (click)="cancelProcurement(item)" class="flex items-center">
      <mat-icon svgIcon="mat:cancel" class="mr-2 text-orange-600"></mat-icon>
      <span class="text-orange-600 font-semibold">Annuler</span>
    </button>

    <button mat-menu-item (click)="edit(item)" class="flex items-center">
      <mat-icon svgIcon="mat:edit" color="primary" class="mr-2"></mat-icon>
      <span>Modifier</span>
    </button>
  </ng-template>
</mat-menu>