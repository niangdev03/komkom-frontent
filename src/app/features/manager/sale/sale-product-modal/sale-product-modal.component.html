<h2 mat-dialog-title class="flex items-center">
  <mat-icon svgIcon="mat:shopping_cart" class="mr-2 text-primary-600"></mat-icon>
  {{ data.isUpdate ? 'Modifier' : 'Ajouter' }} - {{ data.product.name }}
</h2>

<mat-dialog-content>
  <form [formGroup]="productForm">
    <div class="grid gap-4">
      <!-- Image du produit -->
      <div class="flex justify-center">
        <img [src]="data.product.image || 'assets/images/placeholder.png'" [alt]="data.product.name"
          class="h-32 w-32 object-contain rounded-lg border border-gray-200">
      </div>

      <!-- Stock disponible -->
      <div class="bg-blue-50 p-3 rounded-md border-l-4 border-blue-500">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <mat-icon svgIcon="mat:inventory" class="text-blue-600 mr-2"></mat-icon>
            <span class="text-sm">
              Stock disponible ({{ data.product.base_unit }}): <strong>{{ (data.product.base_unit_quantity ||
                data.product.stock_quantity) | quantityFormat }}</strong>
            </span>
          </div>
        </div>
        <div *ngIf="selectedUnitOfMeasure && !selectedUnitOfMeasure.is_base_unit" class="mt-2 text-xs text-blue-700">
          Soit environ <strong>{{ getMaxQuantityForSelectedUnit() }}</strong> {{ selectedUnitOfMeasure.name }}(s)
        </div>
      </div>

      <!-- Unité de mesure -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Unité de mesure</mat-label>
        <mat-select formControlName="unit_of_measure_id">
          <mat-option *ngFor="let unit of data.product.unit_of_measures" [value]="unit.id">
            {{ unit.name }} - {{ unit.price | number }} FCFA
            <span *ngIf="!unit.is_base_unit" class="text-xs text-gray-500">
              (1 {{ unit.name }} = {{ unit.conversion_factor }} {{ data.product.base_unit }})
            </span>
          </mat-option>
        </mat-select>
        <mat-icon matPrefix svgIcon="mat:straighten"></mat-icon>
        <mat-error *ngIf="productForm.get('unit_of_measure_id')?.hasError('required')">
          L'unité de mesure est obligatoire
        </mat-error>
      </mat-form-field>

      <!-- Quantité -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Quantité ({{ selectedUnitOfMeasure.name || '' }})</mat-label>
        <input matInput type="number" formControlName="quantity" min="1" step="0.01">
        <mat-icon matPrefix svgIcon="mat:add_shopping_cart"></mat-icon>
        <mat-hint *ngIf="selectedUnitOfMeasure && !selectedUnitOfMeasure.is_base_unit">
          = {{ getBaseUnitQuantity() | quantityFormat }} {{ data.product.base_unit }}
        </mat-hint>
        <mat-error *ngIf="productForm.get('quantity')?.hasError('required')">
          La quantité est obligatoire
        </mat-error>
        <mat-error *ngIf="productForm.get('quantity')?.hasError('min')">
          La quantité doit être au moins 1
        </mat-error>
      </mat-form-field>

      <!-- Prix unitaire -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Prix unitaire (FCFA / {{ selectedUnitOfMeasure.name || '' }})</mat-label>
        <input matInput type="number" formControlName="unit_price_at_sale" min="0">
        <mat-icon matPrefix svgIcon="mat:attach_money"></mat-icon>
        <mat-error *ngIf="productForm.get('unit_price_at_sale')?.hasError('required')">
          Le prix est obligatoire
        </mat-error>
        <mat-error *ngIf="productForm.get('unit_price_at_sale')?.hasError('min')">
          Le prix doit être positif
        </mat-error>
      </mat-form-field>

      <!-- Numéros de série (si nécessaire) -->
      <div *ngIf="data.product.require_serial_number" class="space-y-3">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Sélectionner les numéros de série</mat-label>
          <mat-select formControlName="selected_serial_numbers" multiple>
            <mat-option *ngFor="let sn of availableSerialNumbers" [value]="sn.id"
              [disabled]="isSerialNumberDisabled(sn.id)">
              {{ sn.serial_number }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix svgIcon="mat:qr_code"></mat-icon>
          <mat-hint>Sélectionnez {{ productForm.get('quantity')?.value || 0 }} numéro(s) de série</mat-hint>
          <mat-error *ngIf="productForm.get('selected_serial_numbers')?.hasError('required')">
            Vous devez sélectionner des numéros de série
          </mat-error>
          <mat-error *ngIf="productForm.get('selected_serial_numbers')?.hasError('mismatchQuantity')">
            Vous devez sélectionner exactement {{ productForm.get('quantity')?.value || 0 }} numéro(s) de série
          </mat-error>
        </mat-form-field>

        <!-- Résumé des numéros de série sélectionnés -->
        <div *ngIf="selectedSerialNumbers.length > 0" class="bg-green-50 p-3 rounded-md border-l-4 border-green-500">
          <div class="flex items-start">
            <mat-icon svgIcon="mat:check_circle" class="text-green-600 mr-2 mt-0.5"></mat-icon>
            <div class="flex-1">
              <p class="text-sm font-medium text-green-800 mb-2">
                Numéros de série sélectionnés ({{ selectedSerialNumbers.length }}/{{ productForm.get('quantity')?.value
                || 0 }})
              </p>
              <div class="flex flex-wrap gap-2">
                <span *ngFor="let sn of getSelectedSerialNumbersDetails()"
                  class="text-xs bg-white px-2 py-1 rounded border border-green-300 text-green-800 font-mono">
                  {{ sn.serial_number }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sous-total -->
      <div class="bg-gray-50 p-4 rounded-md">
        <div class="flex justify-between items-center">
          <span class="text-lg font-medium">Sous-total:</span>
          <span class="text-2xl font-bold text-primary-600">
            {{ getSubtotal() | number }} FCFA
          </span>
        </div>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end" class="mt-4">
  <button mat-button (click)="onCancel()">
    <mat-icon svgIcon="mat:close" class="mr-1"></mat-icon>
    Annuler
  </button>
  <button mat-flat-button color="primary" (click)="onSubmit()" [disabled]="productForm.invalid">
    <mat-icon svgIcon="mat:check" class="mr-1"></mat-icon>
    {{ data.isUpdate ? 'Modifier' : 'Ajouter' }}
  </button>
</mat-dialog-actions>
