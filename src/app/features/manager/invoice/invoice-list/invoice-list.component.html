<vex-page-layout>
    <div class="w-full h-full flex flex-col">
      <div class="px-3 sm:px-6 pt-4 sm:pt-6 pb-4 sm:pb-10 bg-primary-600/10 flex-none">
        <div class="flex items-center justify-between container px-0 gap-2 sm:gap-4">
          <h2 class="display-1 font-bold m-0 flex items-center flex-1 min-w-0">
            <span @scaleIn
              class="w-9 h-9 sm:w-12 sm:h-12 rounded-full text-primary-600 mr-2 sm:mr-4 bg-primary-600/10 flex items-center justify-center flex-shrink-0">
              <mat-icon svgIcon="mat:point_of_sale" class="text-xl sm:text-2xl"></mat-icon>
            </span>
            <span @fadeInRight class="block text-lg sm:text-2xl truncate">Gestion des Factures</span>
          </h2>

          <button class="flex-shrink-0" mat-raised-button color="primary" type="button" (click)="goBack()">
            <mat-icon svgIcon="mat:arrow_back" class="sm:mr-1"></mat-icon>
            <span class="hidden sm:inline">Retour</span>
          </button>
        </div>
      </div>
  </div>

    <vex-page-layout-content [class.container]="layoutCtrl.value === 'fullwidth'"
      [class.px-6]="layoutCtrl.value === 'boxed'" class="-mt-6">
      <div class="card overflow-auto mt-4">
        <!-- Header pour desktop/tablette -->
        <div class="bg-app-bar px-6 h-16 border-b sticky left-0 hidden md:flex items-center">
          <h2 class="title my-0 ltr:pr-4 rtl:pl-4 ltr:mr-4 rtl:ml-4 ltr:border-r rtl:border-l flex-none">
            <span>Liste des factures</span>
          </h2>

          <mat-form-field subscriptSizing="dynamic" class="w-full max-w-lg">
            <mat-icon matIconPrefix svgIcon="mat:search"></mat-icon>
            <input matInput [formControl]="searchCtrl" placeholder="Recherchez ici..." type="text" />
          </mat-form-field>
          <span class="flex-1"></span>
          <mat-form-field subscriptSizing="dynamic" class="ml-2" *ngIf="!selectedRole">
            <mat-label>Filtrer par statut</mat-label>
              <mat-select (selectionChange)="onSelectStatus($event)">
                  <mat-option value="all">Toutes</mat-option>
                  <mat-option value="paid">Payées</mat-option>
                  <mat-option value="partial">Partiellement payées</mat-option>
                  <mat-option value="no_paid">Non payées</mat-option>
                  <mat-option value="cancelled">Annulées</mat-option>
            </mat-select>
          </mat-form-field>

          <button [matMenuTriggerFor]="columnFilterMenu" class="ml-4 flex-none" mat-icon-button
            matTooltip="Filtrer les colonnes" type="button">
            <mat-icon svgIcon="mat:filter_list"></mat-icon>
          </button>
        </div>

        <!-- Header pour mobile -->
        <div class="bg-app-bar px-4 py-3 border-b sticky left-0 md:hidden">
          <div class="flex flex-col gap-3">
            <div class="flex items-center justify-between">
              <h2 class="title my-0 text-base">Liste des factures</h2>
              <button [matMenuTriggerFor]="columnFilterMenu" mat-icon-button type="button">
                <mat-icon svgIcon="mat:filter_list"></mat-icon>
              </button>
            </div>

            <mat-form-field subscriptSizing="dynamic" class="w-full">
              <mat-icon matIconPrefix svgIcon="mat:search"></mat-icon>
              <input matInput [formControl]="searchCtrl" placeholder="Rechercher..." type="text" />
            </mat-form-field>

            <mat-form-field subscriptSizing="dynamic" class="w-full" *ngIf="!selectedRole">
              <mat-label>Statut</mat-label>
              <mat-select (selectionChange)="onSelectStatus($event)">
                <mat-option value="all">Toutes</mat-option>
                <mat-option value="paid">Payées</mat-option>
                <mat-option value="partial">Partiellement payées</mat-option>
                <mat-option value="no_paid">Non payées</mat-option>
                <mat-option value="cancelled">Annulées</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>


        <!-- Vue mobile avec cards -->
        <div class="md:hidden">
          <div *ngIf="invoices.length === 0" class="flex-auto flex flex-col items-center justify-center py-12">
            <img class="h-48" src="assets/img/illustrations/idea.svg" />
            <h2 class="headline mt-4 text-center px-4">
              <span>Aucune facture ne correspond à vos filtres</span>
            </h2>
          </div>

          <div *ngIf="invoices.length > 0" class="flex flex-col gap-3 p-4">
            <div *ngFor="let invoice of invoices" class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
              <!-- En-tête de la card -->
              <div class="flex items-start justify-between mb-3 pb-3 border-b border-gray-100">
                <div class="flex-1">
                  <div class="font-bold text-base text-gray-900">{{ invoice.invoice_number }}</div>
                  <div class="text-sm text-gray-600 mt-1">{{ invoice.customer_name }}</div>
                </div>
                <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-bold ring-1 ring-inset"
                  [ngClass]="{
                    'bg-green-50 text-green-700 ring-green-700/10': invoice.invoice_status === 'paid',
                    'bg-yellow-50 text-yellow-700 ring-yellow-700/10': invoice.invoice_status === 'partial',
                    'bg-red-50 text-red-700 ring-red-700/10': invoice.invoice_status === 'no_paid' || invoice.invoice_status === 'cancelled'
                  }">
                  {{ getStatusLabel(invoice.invoice_status) }}
                </span>
              </div>

              <!-- Informations principales -->
              <div class="space-y-2 mb-3">
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">Date</span>
                  <span class="font-medium">{{ invoice.date | date:'dd MMMM yyyy':'':'fr' }}</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">Montant Total</span>
                  <span class="font-bold text-gray-900">{{ invoice.amount_total | integerSeparator }} Fcfa</span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">Montant Payé</span>
                  <span class="inline-flex items-center rounded-md bg-green-600 px-2 py-1 text-xs font-bold text-white">
                    {{ invoice.amount_paid | integerSeparator }} Fcfa
                  </span>
                </div>
                <div class="flex items-center justify-between text-sm">
                  <span class="text-gray-600">Balance</span>
                  <span *ngIf="invoice.balance > 0" class="inline-flex items-center rounded-md bg-red-600 px-2 py-1 text-xs font-bold text-white">
                    {{ invoice.balance | integerSeparator }} Fcfa
                  </span>
                  <span *ngIf="invoice.balance === 0" class="inline-flex items-center gap-1 rounded-md bg-green-600 px-2 py-1 text-xs font-bold text-white">
                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    {{ invoice.balance | integerSeparator }} Fcfa
                  </span>
                </div>
              </div>

              <!-- Actions -->
              <div class="flex items-center justify-end gap-2 pt-3 border-t border-gray-100">
                <button (click)="goToDetail(invoice)" color="primary" mat-icon-button type="button" matTooltip="Voir les détails">
                  <mat-icon svgIcon="mat:remove_red_eye"></mat-icon>
                </button>
                <button (click)="download(invoice)" color="primary" mat-icon-button type="button" matTooltip="Télécharger facture">
                  <mat-icon svgIcon="mat:download"></mat-icon>
                </button>
                <button *ngIf="invoice.invoice_status != 'paid' && invoice.invoice_status!='cancelled'"
                  (click)="payInvoice(invoice)" color="primary" mat-icon-button type="button" matTooltip="Régler">
                  <mat-icon svgIcon="mat:payment"></mat-icon>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Vue desktop/tablette avec table -->
        <table [dataSource]="dataSource" class="w-full hidden md:table" mat-table matSort>
          <ng-container *ngFor="let column of columns">
            <ng-container [matColumnDef]="column.property" *ngIf="column.type === 'text'">
              <th mat-header-cell *matHeaderCellDef class="uppercase" mat-sort-header>
                {{ column.label }}
              </th>
              <td mat-cell *matCellDef="let row" [ngClass]="column.cssClasses">
                <ng-container [ngSwitch]="column.property">
                  <ng-container *ngSwitchDefault>
                    {{ row[column.property] }}
                  </ng-container>

                  <ng-container *ngSwitchCase="'date'">
                    <div class="flex items-center">
                      {{ row[column.property] | date:'dd MMMM yyyy':'':'fr'}}
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'amount_total'">
                    <div class="flex items-center font-bold">
                        {{ row[column.property] | integerSeparator }} Fcfa
                    </div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'amount_paid'">
                    <div class="flex items-center font-bold">
                      <span class="inline-flex items-center rounded-md bg-green-600 px-2 py-1 text-base font-bold text-white">
                        {{ row[column.property] | integerSeparator }} Fcfa
                      </span>
                    </div>
                  </ng-container>
                  <ng-container *ngSwitchCase="'balance'">
                    <div class="flex items-center font-bold">
                      <!-- Balance > 0 : badge rouge -->
                      <span *ngIf="row[column.property] > 0" class="inline-flex items-center rounded-md bg-red-600 px-2 py-1 text-base font-bold text-white">
                        {{ row[column.property] | integerSeparator }} Fcfa
                      </span>

                      <!-- Balance = 0 : badge vert avec icône -->
                      <span *ngIf="row[column.property] === 0" class="inline-flex items-center gap-1 rounded-md bg-green-600 px-2 py-1 text-base font-bold text-white">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                        {{ row[column.property] | integerSeparator }} Fcfa
                      </span>
                    </div>
                  </ng-container>

                  <ng-container *ngSwitchCase="'invoice_status'">
                    <div class="flex items-center">
                      <span
                        class="font-bold inline-flex items-center rounded-md px-2 py-1 font-medium ring-1 ring-inset"
                        [ngClass]="{
                          'bg-green-50 text-green-700 ring-green-700/10': row[column.property] === 'paid',
                          'bg-yellow-50 text-yellow-700 ring-yellow-700/10': row[column.property] === 'partial',
                          'bg-red-50 text-red-700 ring-red-700/10': row[column.property] === 'no_paid' || row[column.property] === 'cancelled'
                        }"
                      >
                        {{ getStatusLabel(row[column.property]) }}
                      </span>
                    </div>
                  </ng-container>


                </ng-container>
              </td>
            </ng-container>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="uppercase">Actions</th>
            <td mat-cell *matCellDef="let row" class="text-secondary">

                <button (click)="goToDetail(row)" color="primary" mat-icon-button type="button" matTooltip="Voir les détails">
                    <mat-icon svgIcon="mat:remove_red_eye"></mat-icon>
                  </button>

                  <!-- Download invoice button -->
                  <button (click)="download(row)" color="primary" mat-icon-button type="button" matTooltip="Télécharger facture">
                    <mat-icon svgIcon="mat:download"></mat-icon>
                  </button>

                  <!-- Pay invoice button -->
                  <button *ngIf="row.invoice_status != 'paid' && row.invoice_status!='cancelled'" (click)="payInvoice(row)" color="primary" mat-icon-button type="button" matTooltip="Régler la facture">
                    <mat-icon svgIcon="mat:payment"></mat-icon>
                  </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="visibleColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: visibleColumns"></tr>
        </table>

        <!-- Empty state pour desktop/tablette -->
        <div *ngIf="invoices.length === 0" class="hidden md:flex flex-auto flex-col items-center justify-center py-12">
          <img class="h-64" src="assets/img/illustrations/idea.svg" />
          <h2 class="headline mt-4 mb-6 text-center">
            <span>Aucune facture ne correspond à vos filtres</span>
          </h2>
        </div>

        <mat-paginator
        *ngIf="invoices.length > 0"
        [pageSizeOptions]="meta.pageSizeOptions"
        [pageSize]="meta.per_page"
        [pageIndex]="meta.current_page - 1"
        [length]="meta.total"
        (page)="pageEvent($event)"
        class="sticky left-0">
      </mat-paginator>

      </div>
    </vex-page-layout-content>
  </vex-page-layout>

  <mat-menu #columnFilterMenu="matMenu" xPosition="before" yPosition="below">
    <button (click)="toggleColumnVisibility(column, $event)" *ngFor="let column of columns" class="mat-menu-item block">
      <mat-checkbox (click)="$event.stopPropagation()" [(ngModel)]="column.visible" color="primary">
        {{ column.label }}
      </mat-checkbox>
    </button>
  </mat-menu>
